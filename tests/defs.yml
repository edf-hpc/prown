usersdb:
  first_uid: 100001
  first_gid: 100001
  users:
    - mike:research
    - anna:engineering
    - marie:research
    - john:engineering
    - ted:engineering
  groups:
    physic:
      - mike
      - anna
      - ted
    biology:
      - marie
      - john
      - ted

tests:

  - name: Fail without arg
    prepare: null
    user: mike
    cmd: $BIN$
    exitcode: 0
    stdout: |
      Saisissez « prown --help » pour plus d'informations.
    stderr: |
      $TMPDIR$/src/prown: opérande manquant

  - name: User cannot prown outside project directory
    prepare: null
    user: john
    cmd: $BIN$ /root
    exitcode: 0
    stat:
      /root:  # check permissions of /root did not changed
        owner: root
        group: root
    stdout: |
      You can't take rights everywhere. Directory '/root' will be ignored
    stderr: null

  - name: User not in owner group cannot prown project directory
    prepare: |
      mkdir lhc
      chown root:physic lhc
    user: john
    cmd: $BIN$ lhc
    exitcode: 0
    stdout: |
      Error: permission denied for project 
             you are not in 'physic' group 
    stderr: null

  - name: User can prown project but it does not change ownership of project root
    prepare: |
      mkdir lhc
      chown root:physic lhc
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stat:
      lhc:
        owner: root
        group: physic
    stdout: |
      group of user: physic
      Setting owner of lhc  directory /var/tmp/projects/lhc to $UID$
    stderr: null

  - name: User in owner group can prown project and become owner of project files
    prepare: |
      mkdir lhc
      chown root:physic lhc
      touch lhc/data
      chown anna:physic lhc/data
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stat:
      lhc:
        owner: root
        group: physic
      lhc/data:
        owner: mike  # prown has changed from anna to mike after recursive work into lhc
        group: physic
    stdout: |
      group of user: physic
      Setting owner of lhc  directory /var/tmp/projects/lhc to $UID$
    stderr: null

  - name: User in owner group can prown directely pointed project file
    prepare: |
      mkdir lhc
      chown root:physic lhc
      touch lhc/data
      chown anna:physic lhc/data
    user: mike
    cmd: $BIN$ lhc/data
    exitcode: 0
    stat:
      lhc:
        owner: root
        group: physic
      lhc/data:
        owner: mike  # prown has changed from anna to mike
        group: physic
    stdout: |
      group of user: physic
      Setting owner of lhc/data  directory /var/tmp/projects/lhc/data to $UID$
      owning file /var/tmp/projects/lhc/data
    stderr: null

  - name: Prown project directory
    prepare: null
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stdout: |
      Warning: directory 'lhc' not found! (ignored)
    stderr: null

  - name: Prown unexisting file
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
    user: mike
    cmd: $BIN$ lhc/unexisting
    exitcode: 0
    stdout: |
      Warning: directory 'lhc/unexisting' not found! (ignored)
    stderr: null

  - name: User can prown multiple files
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        touch lhc/data1
        touch lhc/data2
      }"
    user: mike
    cmd: $BIN$ lhc/data1 lhc/data2
    exitcode: 0
    stat:
      lhc/data1:
        owner: mike  # prown has changed from anna to mike
      lhc/data2:
        owner: mike  # prown has changed from anna to mike
    stdout: |
      group of user: physic
      Setting owner of lhc/data1  directory /var/tmp/projects/lhc/data1 to $UID$
      owning file /var/tmp/projects/lhc/data1
      group of user: physic
      Setting owner of lhc/data2  directory /var/tmp/projects/lhc/data2 to $UID$
      owning file /var/tmp/projects/lhc/data2
    stderr: null

  - name: User can prown multiple directories
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/subdir1
        touch lhc/subdir1/data
        mkdir lhc/subdir2
        touch lhc/subdir2/data
      }"
    user: mike
    cmd: $BIN$ lhc/subdir1 lhc/subdir2
    exitcode: 0
    stat:
      lhc/subdir1:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir1/data:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir2:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir2/data:
        owner: mike  # prown has changed from anna to mike
    stdout: |
      group of user: physic
      Setting owner of lhc/subdir1  directory /var/tmp/projects/lhc/subdir1 to $UID$
      group of user: physic
      Setting owner of lhc/subdir2  directory /var/tmp/projects/lhc/subdir2 to $UID$
    stderr: null

  - name: User can prown glob files
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        touch lhc/data1
        touch lhc/data2
      }"
    user: mike
    cmd: $BIN$ lhc/*
    shell: true
    exitcode: 0
    stat:
      lhc/data1:
        owner: mike  # prown has changed from anna to mike
      lhc/data2:
        owner: mike  # prown has changed from anna to mike
    stdout: |
      group of user: physic
      Setting owner of lhc/data1  directory /var/tmp/projects/lhc/data1 to $UID$
      owning file /var/tmp/projects/lhc/data1
      group of user: physic
      Setting owner of lhc/data2  directory /var/tmp/projects/lhc/data2 to $UID$
      owning file /var/tmp/projects/lhc/data2
    stderr: null

  - name: User can prown glob directories
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/subdir1
        touch lhc/subdir1/data
        mkdir lhc/subdir2
        touch lhc/subdir2/data
      }"
    user: mike
    cmd: $BIN$ lhc/*
    shell: true
    exitcode: 0
    stat:
      lhc/subdir1:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir1/data:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir2:
        owner: mike  # prown has changed from anna to mike
      lhc/subdir2/data:
        owner: mike  # prown has changed from anna to mike
    stdout: |
      group of user: physic
      Setting owner of lhc/subdir1  directory /var/tmp/projects/lhc/subdir1 to $UID$
      group of user: physic
      Setting owner of lhc/subdir2  directory /var/tmp/projects/lhc/subdir2 to $UID$
    stderr: null

  - name: Prown works even if user does not have access to file in a directory
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        touch lhc/data
        chmod 0400 lhc/data
      }"
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stat:
      lhc/data:
        owner: mike  # mike did not had access to lhc/data but prown changed owner anyway
        mode: 0o460  # prown set g+rw
    stdout: |
      group of user: physic
      Setting owner of lhc  directory /var/tmp/projects/lhc to $UID$
    stderr: null

  - name: Prown works even if user does not have access to directly pointed file
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        touch lhc/data
        chmod 0600 lhc/data
      }"
    user: mike
    cmd: $BIN$ lhc/data
    exitcode: 0
    stat:
      lhc/data:
        owner: mike  # mike did not had access to lhc/data but prown changed owner anyway
        mode: 0o660  # prown set g+rw
    stdout: |
      group of user: physic
      Setting owner of lhc/data  directory /var/tmp/projects/lhc/data to $UID$
      owning file /var/tmp/projects/lhc/data
    stderr: null

  - name: Prown works even in user does have access to directory (4ddffaa)
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/subdir
        chmod 700 lhc/subdir
        touch lhc/subdir/data
      }"
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stat:
      lhc/subdir:
        owner: mike  # mike did not had access to lhc/subdir but prown changed owner anyway
        mode: 0o760  # prown set g+rw
      lhc/subdir/data:
        owner: mike  # mike did not had access to lhc/subdir/data but prown changed owner anyway
    stdout: |
      group of user: physic
      Setting owner of lhc  directory /var/tmp/projects/lhc to $UID$
    stderr: null

  - name: Prown does not follow symlink to file inside project directory
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/source
        touch lhc/source/data
        mkdir lhc/target
        touch lhc/target/symlink
        ln -s ../target/symlink lhc/source/symlink
      }"
    user: mike
    cmd: $BIN$ lhc/source
    exitcode: 0
    stat:
      lhc/source/data:
        owner: mike
      lhc/source/symlink:
        owner: mike  # prown has changed owner of the source of the symlink
      lhc/target/symlink:
        owner: anna  # prown did not change symlink target owner inside project directory
    stdout: |
      group of user: physic
      Setting owner of lhc/source  directory /var/tmp/projects/lhc/source to $UID$
    stderr: null

  - name: Prown does not follow symlink to directory inside project directory
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/source
        touch lhc/source/data
        mkdir lhc/target
        touch lhc/target/data
        ln -s ../target lhc/source/symlink
      }"
    user: mike
    cmd: $BIN$ lhc/source
    exitcode: 0
    stat:
      lhc/source/data:
        owner: mike
      lhc/source/symlink:
        owner: mike  # prown has changed owner of the source of the symlink
      lhc/target:
        owner: anna  # prown did not change symlink target directory
      lhc/target/data:
        owner: anna  # prown did not change owner inside directory pointed by the symlink
    stdout: |
      group of user: physic
      Setting owner of lhc/source  directory /var/tmp/projects/lhc/source to $UID$
    stderr: null

  - name: Prown does not follow symlink outside project directory
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        ln -s /root lhc/symlink
      }"
    user: mike
    cmd: $BIN$ lhc
    exitcode: 0
    stat:
      /root:
        owner: root # prown did not change symlink target owner outside project directory
    stdout: |
      group of user: physic
      Setting owner of lhc  directory /var/tmp/projects/lhc to $UID$
    stderr: null

  - name: Prown does not fail with symlink in subdirectory pointing to not accessible target
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        mkdir lhc/source
        touch lhc/source/data
        ln -s fail lhc/source/symlink
      }"
    user: mike
    cmd: $BIN$ lhc/source
    exitcode: 0
    stat:
      lhc/source/data:
        owner: mike
      lhc/source/symlink:
        owner: mike  # prown has changed owner of the source of the symlink even if its target is not accessible
    stdout: |
      group of user: physic
      Setting owner of lhc/source  directory /var/tmp/projects/lhc/source to $UID$
    stderr: null

  - name: Prown fails with direct symlink pointing to not accessible target
    prepare: |
      mkdir lhc
      chown root:physic lhc
      chmod 0770 lhc
      su anna -s /bin/sh -c "{
        ln -s fail lhc/symlink
      }"
    user: mike
    cmd: $BIN$ lhc/symlink
    exitcode: 0
    stat:
      lhc/symlink:
        owner: anna  # prown has not changed the source of the symlink
    stdout: |
      Warning: directory 'lhc/symlink' not found! (ignored)
    stderr: null
